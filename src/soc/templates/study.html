{% extends "layout.html" %}


{% block title %}Study {{ study.study_number }}{% endblock %}


{% block head %}
    {{ super() }}
{% endblock %}


{% block content %}
<div id="waterfall-plot" style="width: 1000px; height: 600px"></div>
<div id="treatment-group-plot" style="width: 1000px; height: 600px"></div>
<div id="spider-plot" style="width: 1000px; height: 600px"></div>
<div id="tgi-plot" style="width: 1000px; height: 600px"></div>

<script>
    $(function() {
        var study = {{ study|tojson }};
        var treatments = {{ treatments|tojson }};
        var measurements = {{ measurements|tojson }};
        var animals = {{ animals|tojson }};

        var groupMap = {};
        var groups = [];
        var animalMap = {};
        animals.forEach(function(animal) {
            animal.measurements = [];
            animal.treatments = [];

            var grpName = animal['group_name'];
            var animalName = animal['animal_name'];
            if(typeof(groupMap[grpName]) === 'undefined') {
                var group = {
                    doseActivities: [],
                    doseUnits: [],
                    doseAmounts: [],
                    uniqTreatDays: [],
                    uniqMeasureDays: [],
                    animals: [],
                    groupName: grpName,
                    groupLabel: null
                };
                groupMap[grpName] = group;
                groups.push(group);
            }

            groupMap[grpName].animals.push(animal);
            animalMap[animalName] = animal;
        });
        groups.sort(function(g1, g2) {
            return g1.groupName.localeCompare(g2.groupName);
        });
        groups.forEach(function(group, i) {
            group.index = i;
        });

        measurements.forEach(function(measurement) {
            var grpName = measurement['group_name'];
            var animalName = measurement['animal_name'];
            var grp = groupMap[grpName];
            var day = measurement['measurement_day'];
            insertUnique(grp.uniqMeasureDays, day);
            animalMap[animalName].measurements.push(measurement);
        });
        treatments.forEach(function(treatment) {
            var grpName = treatment['group_name'];
            var animalName = treatment['animal_name'];
            var grp = groupMap[grpName];
            var day = treatment['treatment_day'];
            insertUnique(grp.uniqTreatDays, day);
            insertUnique(grp.doseActivities, treatment['dose_activity']);
            insertUnique(grp.doseUnits, treatment['administration_route_units']);
            insertUnique(grp.doseAmounts, treatment['test_material_amount']);
            animalMap[animalName].treatments.push(treatment);
        });

        $.each(groupMap, function(grpName, group) {
            var treatmentStartDay = group.uniqTreatDays[0];
            var treatmentEndDay = group.uniqTreatDays[group.uniqTreatDays.length - 1];
            group.nearStartMeasIdx = findNearestMeasureDayIdx(group.uniqMeasureDays, treatmentStartDay);
            group.nearEndMeasIdx = findNearestMeasureDayIdx(group.uniqMeasureDays, treatmentEndDay);
            group.nearStartMeasDay = group.uniqMeasureDays[group.nearStartMeasIdx];
            group.nearEndMeasDay = group.uniqMeasureDays[group.nearEndMeasIdx];
            group.groupLabel =
                    group.doseActivities.join(', ') +
                    ' (' + group.doseAmounts.join(', ') + ' ' + group.doseUnits.join(', ') + ')';
        });

        animals.forEach(function(animal) {
            var grpName = animal['group_name'];
            var grp = groupMap[grpName];

            var measStart = null;
            var measEnd = null;
            animal.measurements.forEach(function(measurement) {
                if(measurement.measurement_day === grp.nearStartMeasDay) {
                    measStart = measurement.measurement_value;
                }
                if(measurement.measurement_day === grp.nearEndMeasDay) {
                    measEnd = measurement.measurement_value;
                }
            });

            if(measEnd === null && animal.measurements.length) {
                var lastMeas = animal.measurements[animal.measurements.length - 1];
                if(lastMeas.measurement_day < grp.nearEndMeasDay) {
                    // indicates that the animal died early
                    // TODO add some visual indication for these animals
                    measEnd = lastMeas.measurement_value;
                }
            }

            if(measStart === null || measEnd === null) {
                console.error('bad measurement for animal: ' + animal.animal_name);
            }
            animal.end_day_measurement = measEnd;
            animal.measurement_diff = measEnd - measStart;
        });
        animals.sort(function(animal1, animal2) {
            return animal2.measurement_diff - animal1.measurement_diff;
        });
        animals.forEach(function(animal, i) {
            animal.index = i;
        });

        var waterfallPlotNode = document.getElementById('waterfall-plot');
        var waterfallPlot = new WaterfallPlot(waterfallPlotNode);
        waterfallPlot.renderPlot(animals, groups, study);

        var spiderPlotNode = document.getElementById('spider-plot');
        var spiderPlot = new SpiderPlot(spiderPlotNode);
        spiderPlot.renderPlot(animals, groupMap, study);

        var treatmentGroupPlotNode = document.getElementById('treatment-group-plot');
        var treatmentGroupPlot = new TreatmentGroupPlot(treatmentGroupPlotNode);
        treatmentGroupPlot.renderPlot(measurements, treatments, groups, study);

        var tgiPlotNode = document.getElementById('tgi-plot');
        var tgiPlot = new TGIPlot(tgiPlotNode);
        tgiPlot.renderPlot(groups, study);
    });
</script>
{% endblock %}
